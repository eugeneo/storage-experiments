<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Storage-experiments by eugeneo</title>
    <script lang="javascript">
      function persist() {
        document.getElementById('info').textContent = 'Running';
        window.localStorage.setItem('a', 'b');
        navigator.storage.persisted().then(result => {
          document.getElementById('info').textContent = result;
          navigator.storage.persist().then(result => {
            document.getElementById('info').textContent += ' ' + result;
            navigator.storage.persisted().then(result => {
              document.getElementById('info').textContent += ' ' + result;
            });
          });
        });
      };

      function store() {
        let data = '';
        for (let i = 0; i < 10000; i++) {
          data += '1234567890 ';
        }
        let num = 1;
        for (let i = 0; i < 10; i++) {
          let key = '';
          do {
            key = 'block ' + (num++);
          } while (window.localStorage.getItem(key));
          window.localStorage.setItem(key, data);
        }
        navigator.webkitTemporaryStorage.queryUsageAndQuota(
            (usage, quota) => {
              document.getElementById('usage').textContent =
                '' + usage + ' of ' + quota;
            },
            e => console.error(e)
          );
      }

      function storeIndexedDB() {
        var req = window.indexedDB.open("TestDB", 2);
        req.onerror = error => console.error(error);
        req.onupgradeneeded = event => {
          console.log('Upgrading!');
          var db = event.target.result;
          console.log('Database: ', db);

          var objectStore =
              db.createObjectStore('some-objects', { keyPath: 'idfield' });
          objectStore.transaction.oncomplete = event => {
            console.log('Transaction complete', event);
            var anotherStore = db.transaction('some-objects', 'readwrite').
                                   objectStore('some-objects');
            for (var i = 0; i < 10000000; i++) {
              anotherStore.add({id: 'someid' + i, name: 'Guy #' + i});
            }
            console.log('Done!');
          }
          console.log('Done!');
        };
        req.onsuccess = event => {
          var db = event.target.result;
          var anotherStore = db.transaction('some-objects', 'readwrite').
                                 objectStore('some-objects');

          var promises = [];
          for (var i = 0; i < 10; i++) {
            promises.push(new Promise((resolve, reject) => {
              console.log('Writing', i);
              var req = anotherStore.add({
                  idfield: 'someid' + i,
                  name: 'Guy #' + i
              });
              req.onsuccess = () => {
                console.log('Done', i);
                resolve();
              };
              req.onerror = error => {
                console.log('Failed', i, error);
                reject();
              }
            }));
          }
          Promise.all(promises).then(obj => console.log('All done', obj));
        };
      }
    </script>
  </head>
  <body>
    <div id="info">Not ran</div>
    <button onclick="persist()">Persist</button>
    <div id="usage">Not ran</div>
    <button onclick="store()">Store</button>

    <div id="indexDBUsage">Not ran</div>
    <button onclick="storeIndexedDB()">Store IndexedDB</button>

  </body>
</html>
