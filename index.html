<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Storage-experiments by eugeneo</title>
    <script lang="javascript">
      function persist() {
        document.getElementById('info').textContent = 'Running';
        window.localStorage.setItem('a', 'b');
        navigator.storage.persisted().then(result => {
          document.getElementById('info').textContent = result;
          navigator.storage.persist().then(result => {
            document.getElementById('info').textContent += ' ' + result;
            navigator.storage.persisted().then(result => {
              document.getElementById('info').textContent += ' ' + result;
            });
          });
        });
      };

      function store() {
        let data = '';
        for (let i = 0; i < 10000; i++) {
          data += '1234567890 ';
        }
        let num = 1;
        for (let i = 0; i < 10; i++) {
          let key = '';
          do {
            key = 'block ' + (num++);
          } while (window.localStorage.getItem(key));
          window.localStorage.setItem(key, data);
        }
        navigator.webkitTemporaryStorage.queryUsageAndQuota(
            (usage, quota) => {
              document.getElementById('usage').textContent =
                '' + usage + ' of ' + quota;
            },
            e => console.error(e)
          );
      }

      function addEntries(db, from, to) {
        var anotherStore = db.transaction('some-objects', 'readwrite').
                               objectStore('some-objects');

        var promises = [];
        for (let i = from; i <= to; i++) {
          promises.push(new Promise((resolve, reject) => {
            var req = anotherStore.add({
                idfield: 'someid' + i,
                name: 'Guy #' + i
            });
            req.onsuccess = () => {
              console.log('Done', i);
              resolve();
            };
            req.onerror = reject;
          }));
        }
        Promise.all(promises).then(obj => console.log('All done', obj.length, 'records'));
      }

      function createStore(db, name, options) {
        return new Promise((resolve, reject) => {
          var transaction = db.createObjectStore(name, options).transaction;
          transaction.oncomplete = resolve;
          transaction.onabort = transaction.onerror = reject;
        });
      }

      function prepareDataBase() {
        return new Promise((resolve, reject) => {
          var req = window.indexedDB.open("TestDB", 3);
          req.onerror = reject;
          req.onupgradeneeded = event => {
            console.log('Upgrading!');
            var db = event.target.result;
            Promise.all([
              createStore(db, 'some-objects', { keyPath: 'idfield' }),
              createStore(db, 'auto-id-object', { autoIncrement: true })
            ]).then(() => resolve(db), reject);
          };
          req.onsuccess = event => resolve(event.target.result);
        });
      }

      function storeIndexedDB() {
        prepareDataBase().then(db => addEntries(event.target.result, 0, 100));
      }

      function indexDBOneRecord() {
        prepareDataBase().then(db => new Promise((resolve, reject) => {
          const req = db.transaction('auto-id-object', 'readwrite')
            .objectStore('auto-id-object').add({afield: new Date()});
          req.onsuccess = resolve;
          req.onerror = reject;
        }));
      }
    </script>
  </head>
  <body>
    <div id="info">Not ran</div>
    <button onclick="persist()">Persist</button>
    <div id="usage">Not ran</div>
    <button onclick="store()">Store</button>

    <div id="indexDBUsage">Not ran</div>
    <button onclick="storeIndexedDB()">Store IndexedDB</button>

    <div id="indexDBOneRecord">Not ran</div>
    <button onclick="indexDBOneRecord()">Add one record</button>

  </body>
</html>
